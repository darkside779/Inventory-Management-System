@model InventoryManagement.WebUI.ViewModels.Payment.CreatePaymentViewModel
@{
    ViewData["Title"] = $"Record Payment - {Model.InvoiceNumber}";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h2 class="h3 mb-0">
                <i class="fas fa-dollar-sign text-success me-2"></i>Record Payment
            </h2>
            <p class="text-muted mb-0">Invoice: @Model.InvoiceNumber - @Model.CustomerName</p>
        </div>
        <div class="col-md-6 text-end">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a asp-controller="Home" asp-action="Index">
                            <i class="fas fa-home"></i> Home
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a asp-controller="Invoice" asp-action="Index">Invoices</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a asp-controller="Invoice" asp-action="Details" asp-route-id="@Model.InvoiceId">@Model.InvoiceNumber</a>
                    </li>
                    <li class="breadcrumb-item active">Record Payment</li>
                </ol>
            </nav>
        </div>
    </div>

    <form asp-action="Create" method="post">
        <input asp-for="InvoiceId" type="hidden" />
        <input asp-for="InvoiceNumber" type="hidden" />
        <input asp-for="CustomerName" type="hidden" />
        <input asp-for="InvoiceTotal" type="hidden" />
        <input asp-for="PaidAmount" type="hidden" />
        
        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

        <div class="row">
            <!-- Payment Form -->
            <div class="col-lg-8">
                <!-- Invoice Summary -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-file-invoice-dollar me-2"></i>Invoice Summary
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-borderless">
                                    <tr>
                                        <td><strong>Invoice Number:</strong></td>
                                        <td>@Model.InvoiceNumber</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Customer:</strong></td>
                                        <td>@Model.CustomerName</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-borderless">
                                    <tr>
                                        <td><strong>Total Amount:</strong></td>
                                        <td class="text-end">@Model.InvoiceTotal.ToString("C")</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Paid Amount:</strong></td>
                                        <td class="text-end text-success">@Model.PaidAmount.ToString("C")</td>
                                    </tr>
                                    <tr class="border-top">
                                        <td><strong>Remaining Balance:</strong></td>
                                        <td class="text-end fw-bold h5 text-primary">@Model.RemainingBalance.ToString("C")</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Details -->
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-credit-card me-2"></i>Payment Details
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Amount" class="form-label">
                                        Payment Amount <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input asp-for="Amount" class="form-control" type="number" step="0.01" min="0.01" max="@Model.RemainingBalance" />
                                    </div>
                                    <span asp-validation-for="Amount" class="text-danger"></span>
                                    <small class="form-text text-muted">Maximum: @Model.RemainingBalance.ToString("C")</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="PaymentDate" class="form-label">
                                        Payment Date <span class="text-danger">*</span>
                                    </label>
                                    <input asp-for="PaymentDate" type="datetime-local" class="form-control" />
                                    <span asp-validation-for="PaymentDate" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="PaymentMethod" class="form-label">
                                        Payment Method <span class="text-danger">*</span>
                                    </label>
                                    <select asp-for="PaymentMethod" asp-items="Model.PaymentMethods" class="form-select">
                                        <option value="">Select payment method...</option>
                                    </select>
                                    <span asp-validation-for="PaymentMethod" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="ReferenceNumber" class="form-label">Reference Number</label>
                                    <input asp-for="ReferenceNumber" class="form-control" placeholder="Leave empty for auto-generation" />
                                    <span asp-validation-for="ReferenceNumber" class="text-danger"></span>
                                    <small class="form-text text-muted">
                                        Auto-generated: @Model.InvoiceNumber-PAY-001 (if left empty)
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label asp-for="Notes" class="form-label">Notes</label>
                                    <textarea asp-for="Notes" class="form-control" rows="3" placeholder="Payment notes or additional information..."></textarea>
                                    <span asp-validation-for="Notes" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions & Payment History -->
            <div class="col-lg-4">
                <!-- Quick Actions -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="card-title mb-0">Quick Actions</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="setFullPayment()">
                                <i class="fas fa-money-bill-wave me-1"></i>Pay Full Amount
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setHalfPayment()">
                                <i class="fas fa-percentage me-1"></i>Pay 50%
                            </button>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="clearAmount()">
                                <i class="fas fa-eraser me-1"></i>Clear Amount
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Submit Actions -->
                <div class="card">
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-1"></i>Record Payment
                            </button>
                            <a asp-controller="Invoice" asp-action="Details" asp-route-id="@Model.InvoiceId" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Back to Invoice
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment History -->
        @if (Model.PaymentHistory.Any())
        {
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-history me-2"></i>Payment History
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Payment #</th>
                                            <th>Date</th>
                                            <th>Amount</th>
                                            <th>Method</th>
                                            <th>Reference</th>
                                            <th>Recorded By</th>
                                            <th>Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var payment in Model.PaymentHistory)
                                        {
                                            <tr>
                                                <td>
                                                    <strong>@payment.PaymentNumber</strong>
                                                </td>
                                                <td>@payment.PaymentDate.ToString("MMM dd, yyyy")</td>
                                                <td class="text-success fw-bold">@payment.Amount.ToString("C")</td>
                                                <td>
                                                    <span class="badge bg-primary">@payment.PaymentMethod</span>
                                                </td>
                                                <td>@(payment.ReferenceNumber ?? "-")</td>
                                                <td>@payment.RecordedByUser</td>
                                                <td>@(payment.Notes ?? "-")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </form>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        // Quick payment amount functions
        function setFullPayment() {
            document.getElementById('Amount').value = @Model.RemainingBalance.ToString("F2");
        }

        function setHalfPayment() {
            const halfAmount = (@Model.RemainingBalance / 2).toFixed(2);
            document.getElementById('Amount').value = halfAmount;
        }

        function clearAmount() {
            document.getElementById('Amount').value = '';
        }

        // Update reference number preview
        function updateReferencePreview() {
            const referenceInput = document.getElementById('ReferenceNumber');
            const helpText = referenceInput.nextElementSibling.nextElementSibling;
            
            if (referenceInput.value.trim() === '') {
                const paymentCount = @(Model.PaymentHistory.Count + 1);
                const autoRef = '@Model.InvoiceNumber' + '-PAY-' + paymentCount.toString().padStart(3, '0');
                helpText.innerHTML = `Auto-generated: <strong>${autoRef}</strong> (if left empty)`;
                helpText.className = 'form-text text-success';
            } else {
                helpText.innerHTML = 'Custom reference number will be used';
                helpText.className = 'form-text text-info';
            }
        }

        // Set default datetime-local value
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            const paymentDateInput = document.getElementById('PaymentDate');
            if (paymentDateInput && !paymentDateInput.value) {
                paymentDateInput.value = localDateTime;
            }
            
            // Set up reference number preview
            const referenceInput = document.getElementById('ReferenceNumber');
            if (referenceInput) {
                referenceInput.addEventListener('input', updateReferencePreview);
                updateReferencePreview(); // Initial call
            }
        });
    </script>
}
