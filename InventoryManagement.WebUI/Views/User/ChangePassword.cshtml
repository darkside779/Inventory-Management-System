@model InventoryManagement.WebUI.ViewModels.Users.ChangePasswordViewModel

@{
    ViewData["Title"] = "Change Password";
}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-key"></i> Change Password
        </h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-action="Index">Users</a></li>
                <li class="breadcrumb-item"><a asp-action="Details" asp-route-id="@Model.UserId">@Model.Username</a></li>
                <li class="breadcrumb-item active" aria-current="page">Change Password</li>
            </ol>
        </nav>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-6">
            <!-- Change Password Form -->
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-warning">
                        <i class="fas fa-shield-alt"></i> 
                        @if (Model.IsAdminReset)
                        {
                            <span>Reset Password for @Model.FullName</span>
                        }
                        else
                        {
                            <span>Change Your Password</span>
                        }
                    </h6>
                </div>
                <div class="card-body">
                    <form asp-action="ChangePassword" method="post" novalidate>
                        <input type="hidden" asp-for="UserId" />
                        <input type="hidden" asp-for="Username" />
                        <input type="hidden" asp-for="FullName" />
                        <input type="hidden" asp-for="IsAdminReset" />
                        
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                        <!-- User Information Display -->
                        <div class="alert alert-info" role="alert">
                            <i class="fas fa-info-circle"></i>
                            <strong>User:</strong> @Model.FullName (@Model.Username)
                            @if (Model.IsAdminReset)
                            {
                                <br><small>You are resetting this user's password as an administrator.</small>
                            }
                        </div>

                        <!-- Current Password (only if not admin reset) -->
                        @if (!Model.IsAdminReset)
                        {
                            <div class="form-group">
                                <label asp-for="CurrentPassword" class="form-label">
                                    <i class="fas fa-lock text-muted"></i> Current Password <span class="text-danger">*</span>
                                </label>
                                <input asp-for="CurrentPassword" class="form-control" placeholder="Enter your current password" />
                                <span asp-validation-for="CurrentPassword" class="text-danger"></span>
                                <small class="form-text text-muted">
                                    Please enter your current password to confirm your identity.
                                </small>
                            </div>
                        }

                        <!-- New Password -->
                        <div class="form-group">
                            <label asp-for="NewPassword" class="form-label">
                                <i class="fas fa-key text-muted"></i> New Password <span class="text-danger">*</span>
                            </label>
                            <input asp-for="NewPassword" class="form-control" placeholder="Enter new password" />
                            <span asp-validation-for="NewPassword" class="text-danger"></span>
                            <div id="password-strength" class="mt-1"></div>
                            <small class="form-text text-muted">
                                Password must be at least 6 characters long.
                            </small>
                        </div>

                        <!-- Confirm New Password -->
                        <div class="form-group">
                            <label asp-for="ConfirmPassword" class="form-label">
                                <i class="fas fa-key text-muted"></i> Confirm New Password <span class="text-danger">*</span>
                            </label>
                            <input asp-for="ConfirmPassword" class="form-control" placeholder="Confirm new password" />
                            <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                        </div>

                        <!-- Send Notification Option -->
                        <div class="form-group">
                            <div class="form-check">
                                <input asp-for="SendNotification" class="form-check-input" />
                                <label asp-for="SendNotification" class="form-check-label">
                                    <i class="fas fa-envelope text-info"></i> Send Password Change Notification
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                @if (Model.IsAdminReset)
                                {
                                    <span>Send an email notification to the user about their password reset.</span>
                                }
                                else
                                {
                                    <span>Send a confirmation email about your password change.</span>
                                }
                            </small>
                        </div>

                        <hr>

                        <!-- Submit Buttons -->
                        <div class="form-group mb-0">
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-save"></i> 
                                @if (Model.IsAdminReset)
                                {
                                    <span>Reset Password</span>
                                }
                                else
                                {
                                    <span>Change Password</span>
                                }
                            </button>
                            <a asp-action="Details" asp-route-id="@Model.UserId" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Security Tips Sidebar -->
        <div class="col-lg-4 offset-lg-1">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-success">
                        <i class="fas fa-shield-alt"></i> Password Security Tips
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="fas fa-check text-success mr-2"></i>
                            <strong>Use a strong password</strong><br>
                            <small class="text-muted">At least 8 characters with mixed case, numbers, and symbols</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success mr-2"></i>
                            <strong>Make it unique</strong><br>
                            <small class="text-muted">Don't reuse passwords from other accounts</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success mr-2"></i>
                            <strong>Avoid personal information</strong><br>
                            <small class="text-muted">Don't use names, birthdays, or common words</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success mr-2"></i>
                            <strong>Keep it secure</strong><br>
                            <small class="text-muted">Never share your password with others</small>
                        </li>
                        <li class="mb-0">
                            <i class="fas fa-check text-success mr-2"></i>
                            <strong>Change regularly</strong><br>
                            <small class="text-muted">Update your password periodically</small>
                        </li>
                    </ul>
                </div>
            </div>

            @if (Model.IsAdminReset)
            {
                <div class="card shadow mt-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-warning">
                            <i class="fas fa-exclamation-triangle"></i> Administrator Notice
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-2">
                            <strong>You are performing a password reset as an administrator.</strong>
                        </p>
                        <ul class="small text-muted mb-0">
                            <li>The user's current password is not required</li>
                            <li>This action will be logged in the audit trail</li>
                            <li>Consider informing the user through a secure channel</li>
                            <li>Advise the user to change their password after first login</li>
                        </ul>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Real-time password strength indicator
            $('#NewPassword').on('input', function() {
                var password = $(this).val();
                var strength = getPasswordStrength(password);
                updatePasswordStrengthIndicator(strength);
            });

            // Password confirmation matching
            $('#ConfirmPassword').on('input', function() {
                var newPassword = $('#NewPassword').val();
                var confirmPassword = $(this).val();
                
                if (confirmPassword && newPassword !== confirmPassword) {
                    showFieldError('ConfirmPassword', 'Passwords do not match.');
                } else {
                    clearFieldError('ConfirmPassword');
                }
            });

            // Form validation
            $('form').on('submit', function(e) {
                var newPassword = $('#NewPassword').val();
                var confirmPassword = $('#ConfirmPassword').val();
                
                if (newPassword !== confirmPassword) {
                    e.preventDefault();
                    showFieldError('ConfirmPassword', 'Passwords do not match.');
                    return false;
                }
                
                if (newPassword.length < 6) {
                    e.preventDefault();
                    showFieldError('NewPassword', 'Password must be at least 6 characters long.');
                    return false;
                }
            });
        });

        function getPasswordStrength(password) {
            var score = 0;
            if (password.length >= 8) score++;
            if (/[a-z]/.test(password)) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[^a-zA-Z0-9]/.test(password)) score++;
            return score;
        }

        function updatePasswordStrengthIndicator(strength) {
            var indicator = $('#password-strength');
            
            if (strength === 0) {
                indicator.html('');
                return;
            }

            var colors = ['danger', 'danger', 'warning', 'info', 'success'];
            var texts = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'];
            var icons = ['fa-times', 'fa-exclamation', 'fa-minus', 'fa-check', 'fa-check-circle'];
            
            var colorClass = colors[strength - 1];
            var text = texts[strength - 1];
            var icon = icons[strength - 1];
            
            indicator.html(`
                <div class="progress" style="height: 5px;">
                    <div class="progress-bar bg-${colorClass}" role="progressbar" style="width: ${strength * 20}%"></div>
                </div>
                <small class="text-${colorClass}">
                    <i class="fas ${icon}"></i> Password Strength: ${text}
                </small>
            `);
        }

        function showFieldError(fieldName, message) {
            var field = $(`#${fieldName}`);
            var errorSpan = field.siblings('.text-danger');
            
            field.addClass('is-invalid');
            if (errorSpan.length > 0) {
                errorSpan.text(message);
            } else {
                field.after(`<span class="text-danger">${message}</span>`);
            }
        }

        function clearFieldError(fieldName) {
            var field = $(`#${fieldName}`);
            field.removeClass('is-invalid');
            field.siblings('.text-danger').text('');
        }
    </script>
}
